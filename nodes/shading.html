<!-- TODOS

    * i18n
    * Passende fa icons
    * Open / Close setpos konfigurierbar machen
    * lat/lon Eingabeformat, passt das so?
 -->


<!-- BEGIN location configuration -->

 <script type="text/javascript">
    RED.nodes.registerType("shading location", {
        category: "config",
        defaults: {
            name: {},
            lat: {value: "", required: true, validate:RED.validators.number()},
            lon: {value: "", required: true, validate:RED.validators.number()},
        },
        label: function() {
            return this.name || "Lat " + this.lat + "° / " + "Lon " + this.lon + "°"
        }
    })
</script>

<script type="text/html" data-template-name="shading location">
    <style>
        .red-ui-editor .form-row label {
            width: 150px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
    </style>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</span></label>
        <input type="text" id="node-config-input-name" placeholder="Home, Apartment, Cabin, ...">
    </div>
    <div class="form-row">
        <label for="node-config-input-lat"><i class="fa fa-compass"></i> Latitude</label>
        <input type="text" id="node-config-input-lat" placeholder="47.479" style="width: 150px;"> °
    </div>
    <div class="form-row">
        <label for="node-config-input-lon"><i class="fa fa-compass"></i> Longitude</label>
        <input type="text" id="node-config-input-lon" placeholder="9.663" style="width: 150px;"> °
    </div>
</script>

<!-- END location configuration -->



<!-- BEGIN automatic configuration -->

<script type="text/javascript">
    RED.nodes.registerType('shading automatic',{
        category: 'config',
        defaults: {
            name: {},
            config: {type: "shading location"},
            orientation: {required: true},
            windowSunAngleEntry: {value: -75, required: true},  // TODO check for -90 - +90°
            windowSunAngleExit: {value: 75, required: true},
            inmsgTopicAutoReenable: {},
            inmsgTopicActPosHeight: {},
            allowLoweringWhenTilted: {},
            allowLoweringWhenOpened: {},
            inmsgWinswitchTopic: {},
            inmsgWinswitchPayloadOpened: {value: 1},
            inmsgWinswitchPayloadOpenedType: {},
            inmsgWinswitchPayloadTilted: {value: 2},
            inmsgWinswitchPayloadTiltedType: {},
            inmsgWinswitchPayloadClosed: {value: 3},
            inmsgWinswitchPayloadClosedType: {},
            hardlock: {},
            hardlockType: {},
            behOpen: {value: "initval"},
            behTilt: {value: "initval"},
            behClose: {value: "initval"},
            autoIfSunrise: {},
            autoIfSunset: {},
            autoIfWinOpenToTilt: {},
            autoIfWinOpenToClosed: {},
            autoIfWinClosed: {},
            autoIfMsgTopic: {},
            openIfWinOpen: {},
            openIfDayTempLow: {},
            openIfSunrise: {},
            openIfSunset: {},
            shadeIfClosedWinOpen: {},
            shadeIfDayTempHigh: {},
            shadeIfSunrise: {},
            shadeIfSunset: {},
            closeIfSunrise: {},
            closeIfSunset: {},
        },
        label: function() {
            return this.name || this.orientation + "°";       // TODO: automatisch zusammenstellen: shading location.name + orientation
        },
        oneditprepare: function() {

            $("#node-config-input-inmsgWinswitchPayloadOpened").typedInput({
                default: "num",
                typeField: $("#node-config-input-inmsgWinswitchPayloadOpenedType"),
                types: ["bool","num","str"]
            })

            $("#node-config-input-inmsgWinswitchPayloadTilted").typedInput({
                default: "num",
                typeField: $("#node-config-input-inmsgWinswitchPayloadTiltedType"),
                types: ["bool","num","str"]
            })

            $("#node-config-input-inmsgWinswitchPayloadClosed").typedInput({
                default: "num",
                typeField: $("#node-config-input-inmsgWinswitchPayloadClosedType"),
                types: ["bool","num","str"]
            })
            
            var optionNothing = {value: "dis", label: "Disabled", hasValue: false};
            $("#node-config-input-hardlock").typedInput({
                default: "dis",
                typeField: $("#node-config-input-hardlockType"),
                types: ["flow","global",optionNothing]
            })
            if (this.behOpen === "initval") {
                $("#node-config-input-behOpen").val("nothing")
            }
            $("#node-config-input-behOpen").typedInput({
                types: [
                    {
                        value: "behOpen",
                        options: [
                            {value: "nothing", label: "Nothing"},
                            {value: "open", label: "Open"},
                            {value: "shade", label: "Shade"},
                            {value: "close", label: "Close"}
                        ]
                    }
                ]
            })
            if (this.behTilt === "initval") {
                $("#node-config-input-behTilt").val("nothing")
            }
            $("#node-config-input-behTilt").typedInput({
                types: [
                    {
                        value: "behTilt",
                        options: [
                            {value: "nothing", label: "Nothing"},
                            {value: "open", label: "Open"},
                            {value: "shade", label: "Shade"},
                            {value: "close", label: "Close"}
                        ]
                    }
                ]
            })
            if (this.behClose === "initval") {
                $("#node-config-input-behClose").val("nothing")
            }
            $("#node-config-input-behClose").typedInput({
                types: [
                    {
                        value: "behClose",
                        options: [
                            {value: "nothing", label: "Nothing"},
                            {value: "open", label: "Open"},
                            {value: "shade", label: "Shade"},
                            {value: "close", label: "Close"}
                        ]
                    }
                ]
            })

        }
    })
</script>

<script type="text/html" data-template-name="shading automatic">
    <style>
        .red-ui-editor .form-row #node-config-input-windowSunAngleEntry,
        .red-ui-editor .form-row #node-config-input-windowSunAngleExit {
            width: 100px
        }
        .red-ui-editor .form-row label {
            width: 150px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
        .red-ui-editor .checkbox-row {
            margin-bottom: 0px
        }
        .red-ui-editor .checkbox-row input {
            margin-left: 20px;
            margin-right: 5px;
            vertical-align: top;
            width: auto !important;
        }
        .red-ui-editor h3 {
            margin-top: 50px
        }
    </style>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="East, Streetside, Garden, ...">
    </div>
    <div class="form-row">
        <label for="node-config-input-config"><i class="fa fa-compass"></i> Home location</label>
        <input type="text" id="node-config-input-config" style="width: 250px;">     <!-- TODO find width css trick -->
    </div>
    <div class="form-row">
        <label for="node-config-input-orientation"><i class="fa fa-location-arrow"></i> Orientation</label>
        <input type="number" id="node-config-input-orientation" style="width:100px" placeholder="0 - 359" min="0" max="359"> °
    </div>
    <div class="form-row">
        <label for="node-config-input-windowSunAngleEntry"><i class="fa fa-location-arrow"></i> Sun entry angle</label>
        <input type="number" id="node-config-input-windowSunAngleEntry" placeholder="-90 - 0" min="-90" max="0"> °
    </div>
    <div class="form-row">
        <label for="node-config-input-windowSunAngleExit"><i class="fa fa-location-arrow"></i> Sun exit angle</label>
        <input type="number" id="node-config-input-windowSunAngleExit" placeholder="0 - 90" min="0" max="90"> °
    </div>

    <div class="form-row">
        <label for="node-config-input-inmsgTopicAutoReenable"><i class="fa fa-tasks"></i> Auto re-enable topic</label>
        <input type="text" id="node-config-input-inmsgTopicAutoReenable" placeholder="Leave blank to use 'auto'">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgTopicActPosHeight"><i class="fa fa-tasks"></i> Actual height position topic</label>  <!-- TODO find better description -->
        <input type="text" id="node-config-input-inmsgTopicActPosHeight" placeholder="Leave blank to use 'heightfeedback'">
    </div>
    <div class="form-row">
        <label><i class="fa fa-bars"></i> Allow lowering when tilted</label>
        <input type="checkbox" id="node-config-input-allowLoweringWhenTilted" checked="checked" style="display:inline-block; width:auto;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-bars"></i> Allow lowering when opened</label>
        <input type="checkbox" id="node-config-input-allowLoweringWhenOpened" style="display:inline-block; width:auto;">
    </div>
    <div class="form-row">
        <label for="node-config-input-hardlock"><i class="fa fa-tag"></i> Hard lock</label>
        <input type="hidden" id="node-config-input-hardlockType">
        <input type="text" id="node-config-input-hardlock">
    </div>
    <h3>Window switch</h3>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-config-input-inmsgWinswitchTopic" placeholder="Leave blank to use 'switch'">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchPayloadOpened"><i class="fa fa-tag"></i> Payload Opened</label>
        <input type="hidden" id="node-config-input-inmsgWinswitchPayloadOpenedType">
        <input type="text" id="node-config-input-inmsgWinswitchPayloadOpened">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchPayloadTilted"><i class="fa fa-tag"></i> Payload Tilted</label>
        <input type="hidden" id="node-config-input-inmsgWinswitchPayloadTiltedType">
        <input type="text" id="node-config-input-inmsgWinswitchPayloadTilted">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchPayloadClosed"><i class="fa fa-tag"></i> Payload Closed</label>
        <input type="hidden" id="node-config-input-inmsgWinswitchPayloadClosedType">
        <input type="text" id="node-config-input-inmsgWinswitchPayloadClosed">
    </div>
    <h3>Events configuration</h3>
    
    <h4>Re-enable automatic conditions</h4>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-autoIfSunrise"> <label style="width: auto" for="node-config-input-autoIfSunrise">Sunrise</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-autoIfSunset"> <label style="width: auto" for="node-config-input-autoIfSunset">Sunset</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-autoIfWinOpenToTilt"> <label style="width: auto" for="node-config-input-autoIfWinOpenToTilt">Window open -> tilted</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-autoIfWinOpenToClosed"> <label style="width: auto" for="node-config-input-autoIfWinOpenToClosed">Window open -> closed</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-autoIfWinClosed"> <label style="width: auto" for="node-config-input-autoIfWinClosed">Window closed</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-autoIfMsgTopic"> <label style="width: auto" for="node-config-input-autoIfMsgTopic">Message with topic XXX</label>
    </div>
    
    <h4>Open conditions</h4>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-openIfWinOpen"> <label style="width: auto" for="node-config-input-openIfWinOpen">Window opens</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-openIfDayTempLow"> <label style="width: auto" for="node-config-input-openIfDayTempLow">Room temperature below limit (at daytime)</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-openIfSunrise"> <label style="width: auto" for="node-config-input-openIfSunrise">Sunrise</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-openIfSunset"> <label style="width: auto" for="node-config-input-openIfSunset">Sunset</label>
    </div>
    
    <h4>Shade conditions</h4>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-shadeIfClosedWinOpen"> <label style="width: auto" for="node-config-input-shadeIfClosedWinOpen">Closed and window open</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-shadeIfDayTempHigh"> <label style="width: auto" for="node-config-input-shadeIfDayTempHigh">At day if room temp is high</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-shadeIfSunrise"> <label style="width: auto" for="node-config-input-shadeIfSunrise">Sunrise</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-shadeIfSunset"> <label style="width: auto" for="node-config-input-shadeIfSunset">Sunset</label>
    </div>
    
    <h4>Close conditions</h4>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-closeIfSunrise"> <label style="width: auto" for="node-config-input-closeIfSunrise">Sunrise</label>
    </div>
    <div class="form-row checkbox-row">
        <input type="checkbox" id="node-config-input-closeIfSunset"> <label style="width: auto" for="node-config-input-closeIfSunset">Sunset</label>
    </div>





    <div class="form-row">
        <label for="node-config-input-behOpen"><i class="fa fa-sliders"></i> Win open action</label>
        <input type="text" id="node-config-input-behOpen">
    </div>
    <div class="form-row">
        <label for="node-config-input-behTilt"><i class="fa fa-sliders"></i> Win tilt action</label>
        <input type="text" id="node-config-input-behTilt">
    </div>
    <div class="form-row">
        <label for="node-config-input-behClose"><i class="fa fa-sliders"></i> Win close action</label>
        <input type="text" id="node-config-input-behClose">
    </div>
</script>

<!-- END automatic configuration -->


<!-- BEGIN basic configuration -->
<script type="text/javascript">
    RED.nodes.registerType ('shading configuration', {
        category: 'config',
        defaults: {
            name: {value: "Shading main configuration"},
            shadingSetposShade: {value: 80, required: true},
            shadingSetposShadeType: {value: "initval"},
            inmsgButtonTopicOpen: {},
            inmsgButtonTopicClose: {},
            payloadOpenCmd: {value: false},
            payloadOpenCmdType: {value: "initval"},
            payloadCloseCmd: {},
            payloadCloseCmdType: {value: "initval"},
            payloadStopCmd: {},
            payloadStopCmdType: {value: "initval"},
        },
        label: function() {
            return this.name || "Shading main configuration";
        },
        oneditprepare: function() {
            // value & type initialisation
            if (this.shadingSetposShadeType === "initval") {
                $("#node-config-input-shadingSetposShadeType").val("num")
            }
            // defining input types
            $("#node-config-input-shadingSetposShade").typedInput({
                default: "num",
                typeField: $("#node-config-input-shadingSetposShadeType"),
                types: ["num"]
            })
            $("#node-config-input-payloadOpenCmd").typedInput({
                default: "bool",
                typeField: $("#node-config-input-payloadOpenCmdType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-payloadCloseCmd").typedInput({
                default: "bool",
                typeField: $("#node-config-input-payloadCloseCmdType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-payloadStopCmd").typedInput({
                default: "bool",
                typeField: $("#node-config-input-payloadStopCmdType"),
                types: ["bool","num","str"]
            })
        }
    })
</script>

<script type="text/html" data-template-name="shading configuration">
    <style>
        .red-ui-editor .form-row label {
            width: 150px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
        .red-ui-editor .form-row #node-config-input-shadingSetposShade {
            width: 100px
        }
    </style>
    <h3>Basics</h3>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Shading main configuration">
    </div>
    <h3>Blind configuration</h3>
    <div class="form-row">
        <label for="node-config-input-shadingSetposShade"><i class="fa fa-window-maximize"></i> Shade position</label>
        <input type="hidden" id="node-config-input-shadingSetposShadeType">
        <input type="text" id="node-config-input-shadingSetposShade">
    </div>
    <h3>Pushbutton configuration</h3>
    <div class="form-row">
        <label for="node-config-input-inmsgButtonTopicOpen"><i class="fa fa-tasks"></i> Topic Open</label>
        <input type="text" id="node-config-input-inmsgButtonTopicOpen" placeholder="Leave blank to use 'openbutton'">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgButtonTopicClose"><i class="fa fa-tasks"></i> Topic Close</label>
        <input type="text" id="node-config-input-inmsgButtonTopicClose" placeholder="Leave blank to use 'closebutton'">
    </div>
    <h3>Command output configuration</h3>
    <div class="form-row">
        <label for="node-config-input-payloadOpenCmd"><i class="fa fa-tag"></i> Payload Open</label>
        <input type="hidden" id="node-config-input-payloadOpenCmdType">
        <input type="text" id="node-config-input-payloadOpenCmd">
    </div>
    <div class="form-row">
        <label for="node-config-input-payloadCloseCmd"><i class="fa fa-tag"></i> Payload Close</label>
        <input type="hidden" id="node-config-input-payloadCloseCmdType">
        <input type="text" id="node-config-input-payloadCloseCmd">
    </div>
    <div class="form-row">
        <label for="node-config-input-payloadStopCmd"><i class="fa fa-tag"></i> Payload Stop</label>
        <input type="hidden" id="node-config-input-payloadStopCmdType">
        <input type="text" id="node-config-input-payloadStopCmd">
    </div>
</script>

<!-- END basic configuration -->


<!-- BEGIN Main node -->

<script type="text/javascript">
    RED.nodes.registerType('shading',{
        category: 'Smart Home',
        color: '#C0DEED',
        inputs: 1,
        outputs: 4,
        outputLabels: ["Open command","Close command","Stop command", "Analog setpoint"],
        icon: "font-awesome/fa-window-maximize",
        defaults: {
            name: {},
            configSet: {type: "shading configuration"},
            debug: {},
            autoActive: {},
            configAutomatic: {type: "shading automatic", required: false} // TODO make required when auto is active
        },
        label: function() {
            return this.name || "Shading"
        },
        oneditprepare: function() {
            // hide feedback config area
            $("#node-input-autoActive").on('change', function() {
                if ($("#node-input-autoActive")[0].checked) {
                    $('#autoConfig').show('fast');
                } else {
                    $('#autoConfig').hide('fast');
                }
            })
        }
    });
</script>

<script type="text/html" data-template-name="shading">
    <style>
        .red-ui-editor .form-row label {width: 130px}
        .red-ui-editor .form-row input {width: 260px}
        .red-ui-editor .form-row a {text-decoration: underline; text-decoration-style: dotted}
    </style>
    <div class="form-tips"><b>Tip:</b> Check out <a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md" target="_blank">this manual</a> or click any title, to receive detailled infromation.</div>
    <h3><a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#basics" target="_blank">Basics</a></h3>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> <a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#name" target="_blank">Name</a></label>
        <input type="text" id="node-input-name" placeholder="Kitchen, Livingroom, ...">
    </div>
    <div class="form-row">
        <label for="node-input-configSet"><i class="fa fa-sliders"></i> <a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#configuration" target="_blank">Configuration</a></label>
        <input type="text" id="node-input-configSet" style="width: 150px;">
    </div>
    <h3><a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#automatic" target="_blank">Automatic</a></h3>
    <div class="form-row">
        <label><i class="fa fa-power-off"></i> <a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#enable" target="_blank">Enable</a></label>
        <input type="checkbox" id="node-input-autoActive" style="display:inline-block; width:auto;">
    </div>
    <div id="autoConfig">
        <div class="form-row">
            <label for="node-input-configAutomatic"><i class="fa fa-sliders"></i> <a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#configuration-1" target="_blank">Configuration</a></label>
            <input type="text" id="node-input-configAutomatic" style="width: 150px;">
        </div>
    </div>
    <h3><a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#automatic" target="_blank">Debugging</a></h3>
    <div class="form-row">
        <label><i class="fa fa-bug"></i> <a href="https://github.com/danube/node-red-contrib-smarthome-shading/blob/master/doc/node.md#enable-1" target="_blank">Enable</a></label>
        <input type="checkbox" id="node-input-debug" style="display:inline-block; width:auto;">
    </div>
</script>

<!-- END Main node -->