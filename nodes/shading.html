<!-- TODOS

    * i18n
    * Passende fa icons
    * Open / Close setpos konfigurierbar machen
    * lat/lon Eingabeformat, passt das so?
 -->


<!-- BEGIN location configuration -->

 <script type="text/javascript">
    RED.nodes.registerType("shading location", {
        category: "config",
        defaults: {
            name: {},
            lat: {value: "", required: true, validate:RED.validators.number()},
            lon: {value: "", required: true, validate:RED.validators.number()},
        },
        label: function() {
            return this.name || "Lat " + this.lat + "° / " + "Lon " + this.lon + "°"
        }
    })
</script>

<script type="text/html" data-template-name="shading location">
    <style>
        .red-ui-editor .form-row label {
            width: 150px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
    </style>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</span></label>
        <input type="text" id="node-config-input-name" placeholder="Home, Apartment, Cabin, ...">
    </div>
    <div class="form-row">
        <label for="node-config-input-lat"><i class="fa fa-compass"></i> Latitude</label>
        <input type="text" id="node-config-input-lat" placeholder="47.4791446" style="width: 150px;"> °
    </div>
    <div class="form-row">
        <label for="node-config-input-lon"><i class="fa fa-compass"></i> Longitude</label>
        <input type="text" id="node-config-input-lon" placeholder="9.6631092" style="width: 150px;"> °
    </div>
</script>

<!-- END location configuration -->



<!-- BEGIN automatic configuration -->

<script type="text/javascript">
    RED.nodes.registerType('shading automatic',{
        category: 'config',
        defaults: {
            name: {},
            config: {type: "shading location"},
            orientation: {required: true},
            windowSunAngleEntry: {value: -75, required: true},  // TODO check for -90 - +90°
            windowSunAngleExit: {value: 75, required: true},
            behSunrise: {value: "initval"},
            behSunset: {value: "initval"},
            inmsgTopicAutoReenable: {},
            behButtonLocksUntil: {value: "initval"},
        },
        label: function() {
            return this.name || this.orientation + "°";       // TODO: automatisch zusammenstellen: shading location.name + orientation
        },
        oneditprepare: function() {
            if (this.behSunrise === "initval") {
                $("#node-config-input-behSunrise").val("nothing")
            }
            if (this.behSunset === "initval") {
                $("#node-config-input-behSunset").val("nothing")
            }
            if (this.behButtonLocksUntil === "initval") {
                $("#node-config-input-behButtonLocksUntil").val("sunriseset")
            }
            $("#node-config-input-behSunrise").typedInput({
                types: [
                    {
                        value: "behSunrise",
                        options: [
                            {value: "nothing", label: "Nothing"},
                            {value: "open", label: "Open"},
                            {value: "shade", label: "Shade"},
                            {value: "close", label: "Close"}
                        ]
                    }
                ]
            })
            $("#node-config-input-behSunset").typedInput({
                types: [
                    {
                        value: "behSunset",
                        options: [
                            {value: "nothing", label: "Nothing"},
                            {value: "open", label: "Open"},
                            {value: "shade", label: "Shade"},
                            {value: "close", label: "Close"}
                        ]
                    }
                ]
            })
            $("#node-config-input-behButtonLocksUntil").typedInput({
                types: [
                    {
                        value: "behButtonLocksUntil",
                        options: [
                            {value: "sunriseset", label: "Next sunrise / sunset"},
                            {value: "autoreenable", label: "Auto re-enable"}       // TODO describe how to manually re-enable
                        ]
                    }
                ]
            })
        }
    })
</script>

<script type="text/html" data-template-name="shading automatic">
    <style>
        .red-ui-editor .form-row #node-config-input-windowSunAngleEntry,
        .red-ui-editor .form-row #node-config-input-windowSunAngleExit {
            width: 100px
        }
        .red-ui-editor .form-row label {
            width: 150px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
    </style>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="East, Streetside, Garden, ...">
    </div>
    <div class="form-row">
        <label for="node-config-input-config"><i class="fa fa-compass"></i> Home location</label>
        <input type="text" id="node-config-input-config" style="width: 250px;">     <!-- TODO find width css trick -->
    </div>
    <div class="form-row">
        <label for="node-config-input-orientation"><i class="fa fa-location-arrow"></i> Orientation</label>
        <input type="number" id="node-config-input-orientation" style="width:100px" placeholder="0 - 359" min="0" max="359"> °
    </div>
    <div class="form-row">
        <label for="node-config-input-windowSunAngleEntry"><i class="fa fa-location-arrow"></i> Sun entry angle</label>
        <input type="number" id="node-config-input-windowSunAngleEntry" placeholder="-90 - 0" min="-90" max="0"> °
    </div>
    <div class="form-row">
        <label for="node-config-input-windowSunAngleExit"><i class="fa fa-location-arrow"></i> Sun exit angle</label>
        <input type="number" id="node-config-input-windowSunAngleExit" placeholder="0 - 90" min="0" max="90"> °
    </div>

    <div class="form-row">
        <label for="node-config-input-behSunrise"><i class="fa fa-sliders"></i> Sunrise action</label>
        <input type="text" id="node-config-input-behSunrise">
    </div>
    <div class="form-row">
        <label for="node-config-input-behSunset"><i class="fa fa-sliders"></i> Sunset action</label>
        <input type="text" id="node-config-input-behSunset">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgTopicAutoReenable"><i class="fa fa-tasks"></i> Auto re-enable topic</label>
        <input type="text" id="node-config-input-inmsgTopicAutoReenable" placeholder="Expecting 'auto' if left blank">
    </div>
    <div class="form-row">
        <label for="node-config-input-behButtonLocksUntil"><i class="fa fa-sliders"></i> Locks until</label>
        <input type="text" id="node-config-input-behButtonLocksUntil">
    </div>

</script>

<!-- END automatic configuration -->


<!-- BEGIN basic configuration -->
<script type="text/javascript">
    RED.nodes.registerType ('shading configuration', {
        category: 'config',
        defaults: {
            name: {required: true},
            shadingSetposOpen: {value: "initval", required: true},  // WORKAROUND: requires "initval" because if 0, the field is left blank.
            shadingSetposOpenType: {value: "initval"},
            shadingSetposShade: {value: 80, required: true},
            shadingSetposShadeType: {value: "initval"},
            shadingSetposClose: {value: 100, required: true},
            shadingSetposCloseType: {value: "initval"},
            inmsgButtonTopicOpen: {},
            inmsgButtonTopicClose: {},
            inmsgWinswitchTopic: {},
            inmsgWinswitchPayloadOpened: {value: 1},
            inmsgWinswitchPayloadOpenedType: {value: "initval"},
            inmsgWinswitchPayloadTilted: {value: 2},
            inmsgWinswitchPayloadTiltedType: {value: "initval"},
            inmsgWinswitchPayloadClosed: {value: 3},
            inmsgWinswitchPayloadClosedType: {value: "initval"},
            payloadOpenCmd: {value: false},
            payloadOpenCmdType: {value: "initval"},
            payloadCloseCmd: {},
            payloadCloseCmdType: {value: "initval"},
            payloadStopCmd: {},
            payloadStopCmdType: {value: "initval"},
        },
        label: function() {
            return this.name
        },
        oneditprepare: function() {
            // value & type initialisation
            if (this.shadingSetposOpen === "initval") {
                $("#node-config-input-shadingSetposOpen").val(0)
            }
            if (this.shadingSetposOpenType === "initval") {
                $("#node-config-input-shadingSetposOpenType").val("num")
            }
            if (this.shadingSetposShadeType === "initval") {
                $("#node-config-input-shadingSetposShadeType").val("num")
            }
            if (this.shadingSetposCloseType === "initval") {
                $("#node-config-input-shadingSetposCloseType").val("num")
            }
            if (this.inmsgWinswitchPayloadOpenedType === "initval") {
                $("#node-config-input-inmsgWinswitchPayloadOpenedType").val("num")
            }
            if (this.inmsgWinswitchPayloadTiltedType === "initval") {
                $("#node-config-input-inmsgWinswitchPayloadTiltedType").val("num")
            }
            if (this.inmsgWinswitchPayloadClosedType === "initval") {
                $("#node-config-input-inmsgWinswitchPayloadClosedType").val("num")
            }
            // if (this.payloadOpenCmdType === "initval") {
            //     $("#node-config-input-payloadOpenCmdType").val("bool")
            // }
            // if (this.payloadCloseCmdType === "initval") {
            //     $("#node-config-input-payloadCloseCmdType").val("bool")
            // }
            // if (this.payloadStopCmdType === "initval") {
            //     $("#node-config-input-payloadStopCmdType").val("bool")
            // }
            // defining input types
            $("#node-config-input-shadingSetposOpen").typedInput({
                default: "num",
                typeField: $("#node-config-input-shadingSetposOpenType"),
                types: ["num"]
            })
            $("#node-config-input-shadingSetposShade").typedInput({
                default: "num",
                typeField: $("#node-config-input-shadingSetposShadeType"),
                types: ["num"]
            })
            $("#node-config-input-shadingSetposClose").typedInput({
                default: "num",
                typeField: $("#node-config-input-shadingSetposCloseType"),
                types: ["num"]
            })
            $("#node-config-input-inmsgWinswitchPayloadOpened").typedInput({
                default: "num",
                typeField: $("#node-config-input-inmsgWinswitchPayloadOpenedType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-inmsgWinswitchPayloadTilted").typedInput({
                default: "num",
                typeField: $("#node-config-input-inmsgWinswitchPayloadTiltedType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-inmsgWinswitchPayloadClosed").typedInput({
                default: "num",
                typeField: $("#node-config-input-inmsgWinswitchPayloadClosedType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-payloadOpenCmd").typedInput({
                default: "bool",
                typeField: $("#node-config-input-payloadOpenCmdType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-payloadCloseCmd").typedInput({
                default: "bool",
                typeField: $("#node-config-input-payloadCloseCmdType"),
                types: ["bool","num","str"]
            })
            $("#node-config-input-payloadStopCmd").typedInput({
                default: "bool",
                typeField: $("#node-config-input-payloadStopCmdType"),
                types: ["bool","num","str"]
            })
        }
    })
</script>

<script type="text/html" data-template-name="shading configuration">
    <style>
        .red-ui-editor .form-row label {
            width: 150px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
        .red-ui-editor .form-row #node-config-input-shadingSetposOpen,
        .red-ui-editor .form-row #node-config-input-shadingSetposShade,
        .red-ui-editor .form-row #node-config-input-shadingSetposClose {
            width: 100px
        }
    </style>
    <div class="form-row">
        <label for="node-config-input-name"><i class="fa fa-bookmark"></i> Name</label>
        <input type="text" id="node-config-input-name" placeholder="Name of onfiguration set">
    </div>
    <h3>Blind configuration</h3>
    <div class="form-row">
        <label for="node-config-input-shadingSetposOpen"><i class="fa fa-window-maximize"></i> Open value</label>
        <input type="hidden" id="node-config-input-shadingSetposOpenType">
        <input type="text" id="node-config-input-shadingSetposOpen">
    </div>
    <div class="form-row">
        <label for="node-config-input-shadingSetposShade"><i class="fa fa-window-maximize"></i> Shade value</label>
        <input type="hidden" id="node-config-input-shadingSetposShadeType">
        <input type="text" id="node-config-input-shadingSetposShade">
    </div>
    <div class="form-row">
        <label for="node-config-input-shadingSetposClose"><i class="fa fa-window-maximize"></i> Close value</label>
        <input type="hidden" id="node-config-input-shadingSetposCloseType">
        <input type="text" id="node-config-input-shadingSetposClose">
    </div>
    <h3>Pushbutton configuration</h3>
    <div class="form-row">
        <label for="node-config-input-inmsgButtonTopicOpen"><i class="fa fa-tasks"></i> Topic Open</label>
        <input type="text" id="node-config-input-inmsgButtonTopicOpen" placeholder="Expecting 'openbutton' if left blank">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgButtonTopicClose"><i class="fa fa-tasks"></i> Topic Close</label>
        <input type="text" id="node-config-input-inmsgButtonTopicClose" placeholder="Expecting 'closebutton' if left blank">
    </div>
    <h3>Window switch</h3>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchTopic"><i class="fa fa-tasks"></i> Topic</label>
        <input type="text" id="node-config-input-inmsgWinswitchTopic" placeholder="Expecting 'switch' if left blank">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchPayloadOpened"><i class="fa fa-tag"></i> Payload Opened</label>
        <input type="hidden" id="node-config-input-inmsgWinswitchPayloadOpenedType">
        <input type="text" id="node-config-input-inmsgWinswitchPayloadOpened">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchPayloadTilted"><i class="fa fa-tag"></i> Payload Tilted</label>
        <input type="hidden" id="node-config-input-inmsgWinswitchPayloadTiltedType">
        <input type="text" id="node-config-input-inmsgWinswitchPayloadTilted">
    </div>
    <div class="form-row">
        <label for="node-config-input-inmsgWinswitchPayloadClosed"><i class="fa fa-tag"></i> Payload Closed</label>
        <input type="hidden" id="node-config-input-inmsgWinswitchPayloadClosedType">
        <input type="text" id="node-config-input-inmsgWinswitchPayloadClosed">
    </div>
    <h3>Command output configuration</h3>
    <div class="form-row">
        <label for="node-config-input-payloadOpenCmd"><i class="fa fa-tag"></i> Payload Open</label>
        <input type="hidden" id="node-config-input-payloadOpenCmdType">
        <input type="text" id="node-config-input-payloadOpenCmd">
    </div>
    <div class="form-row">
        <label for="node-config-input-payloadCloseCmd"><i class="fa fa-tag"></i> Payload Close</label>
        <input type="hidden" id="node-config-input-payloadCloseCmdType">
        <input type="text" id="node-config-input-payloadCloseCmd">
    </div>
    <div class="form-row">
        <label for="node-config-input-payloadStopCmd"><i class="fa fa-tag"></i> Payload Stop</label>
        <input type="hidden" id="node-config-input-payloadStopCmdType">
        <input type="text" id="node-config-input-payloadStopCmd">
    </div>
</script>

<!-- END basic configuration -->


<!-- BEGIN Main node -->

<script type="text/javascript">
    RED.nodes.registerType('shading',{
        category: 'Smart Home',
        color: '#C0DEED',
        inputs: 1,
        outputs: 4,
        outputLabels: ["Open command","Close command","Stop command", "Analog setpoint"],
        icon: "font-awesome/fa-window-maximize",
        defaults: {
            name: {},
            configSet: {type: "shading configuration"},
            debug: {},
            autoActive: {},
            configAutomatic: {type: "shading automatic", required: false} // TODO make required only when visible
        },
        label: function() {
            return this.name || "Shading"
        },
        oneditprepare: function() {
            // hide feedback config area
            $("#node-input-autoActive").on('change', function() {
                if ($("#node-input-autoActive")[0].checked) {
                    $('#autoConfig').show('fast');
                } else {
                    $('#autoConfig').hide('fast');
                }
            })
        }
    });
</script>

<script type="text/html" data-template-name="shading">
    <style>
        .red-ui-editor .form-row label {
            width: 170px
        }
        .red-ui-editor .form-row input {
            width: 250px
        }
    </style>
    <div class="form-row">
        <label for="node-input-name"><i class="fa fa-tag"></i> Name</label>
        <input type="text" id="node-input-name" placeholder="Kitchen, Livingroom, ...">
    </div>
    <div class="form-row">
        <label for="node-input-configSet"><i class="fa fa-sliders"></i> Configuration</label>
        <input type="text" id="node-input-configSet" style="width: 150px;">
    </div>
    <div class="form-row">
        <label><i class="fa fa-power-off"></i> Enable automatic</label>
        <input type="checkbox" id="node-input-autoActive" style="display:inline-block; width:auto;">
    </div>
    <div id="autoConfig">
        <div class="form-row">
            <label for="node-input-configAutomatic"><i class="fa fa-sliders"></i> Auto configuration</label>
            <input type="text" id="node-input-configAutomatic" style="width: 150px;">
        </div>
    </div>
    <div class="form-row">
        <label><i class="fa fa-bug"></i> Enable debugging</label>
        <input type="checkbox" id="node-input-debug" style="display:inline-block; width:auto;">
    </div>
</script>

<!-- END Main node -->
